rules:
  # ===========================================
  # SECRETS & CREDENTIALS
  # ===========================================

  - id: hardcoded-secret-generic
    pattern-regex: |
      (?i)(api[_-]?key|password|passwd|secret|token|auth[_-]?token|bearer|access[_-]?key|private[_-]?key)\s*[=:]\s*["'][A-Za-z0-9+/=_-]{16,}["']
    message: "Potential hardcoded secret detected. Use environment variables instead."
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: secrets
      cwe: "CWE-798: Use of Hard-coded Credentials"

  - id: hardcoded-example-secret
    pattern-regex: |
      (?i)(api[_-]?key|secret[_-]?key|auth[_-]?token)\s*[=:]\s*["']EXAMPLE[_A-Z]+["']
    message: "Hardcoded example/placeholder secret detected. Use environment variables instead."
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: secrets
      cwe: "CWE-798: Use of Hard-coded Credentials"

  - id: js-hardcoded-config-secret
    patterns:
      - pattern: |
          export const $CONFIG = {
            ...
            apiKey: "...",
            ...
          }
    message: "Hardcoded API key in config export. Use process.env.API_KEY instead."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: secrets
      cwe: "CWE-798: Use of Hard-coded Credentials"

  - id: aws-access-key-id
    pattern-regex: "AKIA[0-9A-Z]{16}"
    message: "AWS Access Key ID detected. Never commit AWS keys."
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: secrets
      cwe: "CWE-798: Use of Hard-coded Credentials"

  - id: aws-secret-key
    pattern-regex: |
      (?i)aws[_-]?(secret[_-]?access[_-]?key|access[_-]?key[_-]?id)\s*[=:]\s*["'][A-Za-z0-9+/]{20,}["']
    message: "AWS credentials detected. Never commit AWS keys."
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: secrets
      cwe: "CWE-798: Use of Hard-coded Credentials"

  - id: private-key
    pattern-regex: "-----BEGIN (RSA |EC |DSA |OPENSSH |PGP )?PRIVATE KEY-----"
    message: "Private key detected in source code."
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: secrets

  # ===========================================
  # INJECTION VULNERABILITIES - PYTHON
  # ===========================================

  - id: python-sql-injection-fstring
    pattern: |
      $QUERY = f"...$VAR..."
      ...
      $CURSOR.execute($QUERY)
    message: "Potential SQL injection via f-string. Use parameterized queries: cursor.execute('SELECT * FROM table WHERE col = ?', (value,))"
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-89: SQL Injection"

  - id: python-sql-injection-percent
    pattern: |
      $QUERY = "..." % $VAR
      ...
      $CURSOR.execute($QUERY)
    message: "Potential SQL injection via % formatting. Use parameterized queries."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-89: SQL Injection"

  - id: python-sql-injection-concat
    pattern: |
      $QUERY = "..." + $VAR
      ...
      $CURSOR.execute($QUERY)
    message: "Potential SQL injection via string concatenation. Use parameterized queries."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-89: SQL Injection"

  - id: python-command-injection-subprocess-run
    pattern: subprocess.run($CMD, shell=True, ...)
    message: "Command injection risk with shell=True. Use shell=False and pass arguments as a list."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  - id: python-command-injection-subprocess-call
    pattern: subprocess.call($CMD, shell=True, ...)
    message: "Command injection risk with shell=True. Use shell=False and pass arguments as a list."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  - id: python-command-injection-subprocess-popen
    pattern: subprocess.Popen($CMD, shell=True, ...)
    message: "Command injection risk with shell=True. Use shell=False and pass arguments as a list."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  - id: python-command-injection-os-system
    pattern: os.system($CMD)
    message: "os.system is vulnerable to command injection. Use subprocess with shell=False."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  - id: python-command-injection-os-popen
    pattern: os.popen($CMD)
    message: "os.popen is vulnerable to command injection. Use subprocess with shell=False."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  # ===========================================
  # INJECTION VULNERABILITIES - JAVASCRIPT
  # ===========================================

  - id: js-sql-injection-template
    pattern: $DB.query(`...${$VAR}...`)
    message: "Potential SQL injection. Use parameterized queries."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-89: SQL Injection"

  - id: js-sql-injection-execute
    pattern: $DB.execute(`...${$VAR}...`)
    message: "Potential SQL injection. Use parameterized queries."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-89: SQL Injection"

  - id: js-command-injection-exec
    pattern: exec($CMD)
    message: "Potential command injection. Avoid shell execution with user input."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  - id: js-command-injection-execsync
    pattern: execSync($CMD)
    message: "Potential command injection. Avoid shell execution with user input."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  - id: js-command-injection-spawn-shell
    patterns:
      - pattern: "spawn($CMD, { shell: true })"
    message: "Potential command injection. Avoid shell=true with user input."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-78: OS Command Injection"

  # ===========================================
  # DANGEROUS FUNCTIONS
  # ===========================================

  - id: python-eval-usage
    pattern: eval($X)
    message: "eval is dangerous and can lead to code injection. Avoid if possible."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: dangerous-function
      cwe: "CWE-95: Eval Injection"

  - id: python-exec-usage
    pattern: exec($X)
    message: "exec is dangerous and can lead to code injection. Avoid if possible."
    severity: ERROR
    languages:
      - python
    metadata:
      category: security
      subcategory: dangerous-function
      cwe: "CWE-95: Eval Injection"

  - id: js-eval-usage
    pattern: eval($X)
    message: "eval is dangerous. Avoid dynamic code execution."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: dangerous-function
      cwe: "CWE-95: Eval Injection"

  - id: js-function-constructor
    pattern: new Function($X)
    message: "Function constructor is dangerous. Avoid dynamic code execution."
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: dangerous-function
      cwe: "CWE-95: Eval Injection"

  - id: python-pickle-load
    pattern: pickle.load($X)
    message: "pickle.load is vulnerable to arbitrary code execution. Use safer alternatives like JSON."
    severity: WARNING
    languages:
      - python
    metadata:
      category: security
      subcategory: deserialization
      cwe: "CWE-502: Deserialization of Untrusted Data"

  - id: python-pickle-loads
    pattern: pickle.loads($X)
    message: "pickle.loads is vulnerable to arbitrary code execution. Use safer alternatives like JSON."
    severity: WARNING
    languages:
      - python
    metadata:
      category: security
      subcategory: deserialization
      cwe: "CWE-502: Deserialization of Untrusted Data"

  # ===========================================
  # PATH TRAVERSAL
  # ===========================================

  - id: python-path-traversal-fstring
    pattern: open(f"$PATH{$VAR}...")
    message: "Potential path traversal. Validate and sanitize file paths."
    severity: WARNING
    languages:
      - python
    metadata:
      category: security
      subcategory: path-traversal
      cwe: "CWE-22: Path Traversal"

  - id: python-path-traversal-concat
    pattern: open($PATH + $VAR)
    message: "Potential path traversal. Validate and sanitize file paths."
    severity: WARNING
    languages:
      - python
    metadata:
      category: security
      subcategory: path-traversal
      cwe: "CWE-22: Path Traversal"

  - id: js-path-traversal-readfile
    pattern: fs.readFile(`$PATH${$VAR}...`)
    message: "Potential path traversal. Validate and sanitize file paths."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: path-traversal
      cwe: "CWE-22: Path Traversal"

  - id: js-path-traversal-readfilesync
    pattern: fs.readFileSync(`$PATH${$VAR}...`)
    message: "Potential path traversal. Validate and sanitize file paths."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: path-traversal
      cwe: "CWE-22: Path Traversal"

  # ===========================================
  # CRYPTOGRAPHY
  # ===========================================

  - id: python-weak-crypto-md5
    pattern: hashlib.md5($X)
    message: "MD5 is cryptographically weak. Use SHA-256 or stronger."
    severity: WARNING
    languages:
      - python
    metadata:
      category: security
      subcategory: cryptography
      cwe: "CWE-328: Use of Weak Hash"

  - id: js-weak-crypto-md5
    patterns:
      - pattern: crypto.createHash("md5")
      - pattern: crypto.createHash('md5')
    message: "MD5 is cryptographically weak. Use SHA-256 or stronger."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: cryptography
      cwe: "CWE-328: Use of Weak Hash"

  - id: python-weak-crypto-sha1
    pattern: hashlib.sha1($X)
    message: "SHA1 is cryptographically weak for security purposes. Use SHA-256 or stronger."
    severity: WARNING
    languages:
      - python
    metadata:
      category: security
      subcategory: cryptography
      cwe: "CWE-328: Use of Weak Hash"

  - id: js-weak-crypto-sha1
    patterns:
      - pattern: crypto.createHash("sha1")
      - pattern: crypto.createHash('sha1')
    message: "SHA1 is cryptographically weak for security purposes. Use SHA-256 or stronger."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: cryptography
      cwe: "CWE-328: Use of Weak Hash"

  # ===========================================
  # DEBUG & DEVELOPMENT CODE
  # ===========================================

  - id: debug-print-password
    patterns:
      - pattern: print(..., $PASSWORD, ...)
      - metavariable-regex:
          metavariable: $PASSWORD
          regex: "(?i)(password|passwd|secret|token|key)"
    message: "Logging potentially sensitive data. Remove before production."
    severity: WARNING
    languages:
      - python
    metadata:
      category: security
      subcategory: logging

  - id: console-log-sensitive
    patterns:
      - pattern: console.log(..., $SENSITIVE, ...)
      - metavariable-regex:
          metavariable: $SENSITIVE
          regex: "(?i)(password|passwd|secret|token|key|credential)"
    message: "Logging potentially sensitive data. Remove before production."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: logging

  # ===========================================
  # RUST SPECIFIC
  # ===========================================

  - id: rust-unsafe-block
    pattern: "unsafe { ... }"
    message: "Unsafe block detected. Ensure memory safety is maintained."
    severity: WARNING
    languages:
      - rust
    metadata:
      category: security
      subcategory: memory-safety

  - id: rust-unwrap-in-production
    pattern: $X.unwrap()
    message: "unwrap() can panic. Consider using expect() with a message or proper error handling."
    severity: WARNING
    languages:
      - rust
    metadata:
      category: quality
      subcategory: error-handling

  # ===========================================
  # SSRF (Server-Side Request Forgery)
  # ===========================================

  - id: js-ssrf-fetch
    patterns:
      - pattern: fetch($URL)
      - pattern-not: fetch("...")
    message: "Potential SSRF. Validate and allowlist URLs before fetching user-controlled input."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: ssrf
      cwe: "CWE-918: Server-Side Request Forgery"

  - id: js-ssrf-axios
    patterns:
      - pattern: axios.get($URL)
      - pattern-not: axios.get("...")
    message: "Potential SSRF. Validate and allowlist URLs before making requests."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: ssrf
      cwe: "CWE-918: Server-Side Request Forgery"

  # ===========================================
  # PROTOTYPE POLLUTION
  # ===========================================

  - id: js-prototype-pollution-merge
    pattern: |
      for (const $KEY in $SOURCE) {
        ...
        $TARGET[$KEY] = ...
        ...
      }
    message: "Potential prototype pollution. Check for __proto__ and constructor.prototype before assignment."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: prototype-pollution
      cwe: "CWE-1321: Improperly Controlled Modification of Object Prototype"

  - id: js-prototype-pollution-bracket
    pattern: $OBJ[$KEY] = $VALUE
    message: "Dynamic property assignment may lead to prototype pollution if key is user-controlled."
    severity: INFO
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: prototype-pollution
      cwe: "CWE-1321: Improperly Controlled Modification of Object Prototype"

  # ===========================================
  # INSECURE RANDOMNESS
  # ===========================================

  - id: js-insecure-random
    pattern: Math.random()
    message: "Math.random() is not cryptographically secure. Use crypto.randomBytes() or crypto.getRandomValues() for security-sensitive operations."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: cryptography
      cwe: "CWE-330: Use of Insufficiently Random Values"

  # ===========================================
  # NOSQL INJECTION
  # ===========================================

  - id: js-nosql-injection-find
    pattern: $COLLECTION.find($QUERY)
    message: "Potential NoSQL injection. Validate and sanitize query objects, especially $where clauses."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-943: Improper Neutralization of NoSQL Injection"

  - id: js-nosql-injection-findone
    pattern: $COLLECTION.findOne($QUERY)
    message: "Potential NoSQL injection. Validate and sanitize query objects."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-943: Improper Neutralization of NoSQL Injection"

  - id: js-nosql-injection-aggregate
    pattern: $COLLECTION.aggregate($PIPELINE)
    message: "Potential NoSQL injection in aggregation pipeline. Validate user input."
    severity: WARNING
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: injection
      cwe: "CWE-943: Improper Neutralization of NoSQL Injection"
