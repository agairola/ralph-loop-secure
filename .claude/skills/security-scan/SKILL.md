---
name: security-scan
description: Run ASH (Automated Security Helper) security scan
allowed-tools: Read, Grep, Glob, Bash(uvx:*), Bash(ash:*), Bash(jq:*), Bash(git:diff|status|log), Bash(cat:*), Bash(mkdir:*)
---

# Security Scan

Run ASH (Automated Security Helper) - a comprehensive security scanning tool that bundles multiple scanners into a unified interface.

## Purpose

This skill performs security scanning using ASH, which includes:
- **Semgrep** (SAST) - Static code analysis with custom rules support
- **Bandit** (SAST) - Python-specific security analysis
- **Grype** (SCA) - Dependency vulnerability scanning (replaces Snyk, no auth needed)
- **detect-secrets** - Hardcoded secret detection
- **Checkov** (IaC) - Terraform, CloudFormation, Kubernetes, Dockerfile scanning

## What It Scans

| Scanner | Type | What It Does |
|---------|------|--------------|
| Semgrep | SAST | Multi-language code analysis (includes custom rules) |
| Bandit | SAST | Python-specific security analysis |
| Grype | SCA | Multi-language dependency scanning |
| detect-secrets | Secrets | All text files for hardcoded secrets |
| Checkov | IaC | Infrastructure-as-code validation |

## Usage

```
/security-scan
```

Run this skill after implementing a story and staging changes, but BEFORE committing.

## Process

1. **Get Changed Files**: Identify staged/changed files using git
2. **Run ASH**: Execute ASH in local mode against the project
3. **Parse Results**: Read unified JSON output from ASH
4. **Report**: Output structured results for Claude to act on

## Scan Execution

### Run ASH

```bash
# Create output directory
mkdir -p .ash/ash_output

# Run ASH in local mode (Python tools via UV)
uvx --from git+https://github.com/awslabs/automated-security-helper.git@v3.1.5 \
  ash --mode local --source-dir . --output-dir .ash/ash_output
```

### Check Results

```bash
# Read aggregated results
cat .ash/ash_output/ash_aggregated_results.json | jq '.'

# Or read the summary
cat .ash/ash_output/reports/ash.summary.txt
```

## Output Locations

ASH generates unified output in `.ash/ash_output/`:

| File | Description |
|------|-------------|
| `ash_aggregated_results.json` | Machine-readable results |
| `reports/ash.summary.txt` | Human-readable summary |
| `reports/ash.summary.md` | Markdown summary |
| `reports/ash.sarif` | SARIF format for IDE integration |
| `reports/ash.html` | Interactive HTML report |

## Output Format

After running ASH, report findings in this format:

```
=== Security Scan Results ===
Status: PASS | FAIL

ASH Findings (N total):
- [ERROR] file:line - scanner/rule-id
  Message: Description of the vulnerability
  Fix: Recommended remediation

- [WARNING] file:line - scanner/rule-id
  Message: Description
  Fix: Recommendation

Dependency Vulnerabilities (N total):
- [HIGH] package@version - CVE-YYYY-XXXXX
  Title: Vulnerability title
  Fix: Upgrade to version X.Y.Z

=== Summary ===
Total: X findings (Y errors, Z warnings)
Overall: PASS | FAIL
```

## Decision Logic

- **PASS**: No ERROR-level findings, no HIGH severity vulnerabilities
- **FAIL**: Any ERROR-level finding OR any HIGH severity vulnerability

Warnings and medium-severity findings are reported but don't cause a FAIL.

## After Scanning

### If PASS
- Proceed to commit
- Update PRD to mark story complete

### If FAIL
1. Read each finding carefully (file:line provided)
2. Apply fix using secure coding patterns from CLAUDE.md
3. Stage the fixes: `git add -A`
4. Re-run `/security-scan`
5. Repeat until PASS (max 3 attempts)

### If Still Failing After 3 Attempts
1. DO NOT commit vulnerable code
2. Create GitHub issue with findings (using `gh` CLI)
3. Add note to progress.txt
4. Move to next incomplete story

## GitHub Issue Escalation

When stuck after 3 attempts:

```bash
gh issue create \
  --title "Security: [STORY_ID] - Unable to resolve [VULN_TYPE]" \
  --body "## Findings

[Paste scanner findings here]

## Attempted Fixes

1. [Description of first fix attempt]
2. [Description of second fix attempt]
3. [Description of third fix attempt]

## Context

Story: [STORY_ID] - [STORY_TITLE]
Files affected: [list files]

Generated by Ralph Loop Secure" \
  --label "security,ralph-escalation"
```

## Thresholds

ASH uses thresholds from `.ash/ash.yaml`:

```yaml
global_settings:
  severity_threshold: MEDIUM
  fail_on_findings: true
```

## Custom Rules

Your existing Semgrep rules are preserved. ASH runs Semgrep with both its default rulesets AND your custom rules:

```yaml
# In .ash/ash.yaml
scanners:
  semgrep:
    enabled: true
    options:
      config_paths:
        - rules/semgrep-rules.yml
```

## Troubleshooting

### ASH not found
ASH runs via uvx, ensure UV is installed:
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### UV not found
```bash
brew install uv
# or
pip install uv
```

### Permission denied
Ensure the output directory exists and is writable:
```bash
mkdir -p .ash/ash_output
```

### Scanner-specific issues
Check individual scanner logs in `.ash/ash_output/logs/`
